<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Box</title>

    <!-- Link to Bootstrap CSS and custom CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style2.css">
    <!-- Link to Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

    <!-- Define resumeToneContext selectSound function in the head -->
    <script>
        // Define players in the global scope
        let players = {
            drums: null,
            bass: null,
            chords: null,
            melodies: null
        };

        // Define a flag to check if the AudioContext has been resumed
        let audioContextResumed = false;

        window.resumeToneContext = async function() {
            if(!audioContextResumed){ // Check if the AudioContext has NOT been resumed yet
                if (window.Tone && window.Tone.context && window.Tone.context.state !== 'running') {
                await window.Tone.context.resume();
                console.log('Audio context resumed');
                audioContextResumed = true; // Set the flag to true
                }
            }
        }

        function playSound() {
            if (!audioContextResumed) {
                console.log('AudioContext has not been resumed yet');
                return;
            }
        }

            // Function to select sound
            async function selectSound(element, type) {
                if (!audioContextResumed) {
                    console.log('AudioContext has not been resumed yet');
                    return;
                }
                const audioFile = element.getAttribute('data-audio');
                console.log('Audio file:', audioFile); // Print the value of audioFile

                document.getElementById(`${type}-selection`).value = audioFile;

                // Stop the currently playing sound of the same type, if any
                if (players[type]) {
                    players[type].stop();
                }


                // Create the Tone.Player instance here, after the audio context has been resumed
                players[type] = new Tone.Player(audioFile).toDestination();

                try {
                    await players[type].load(); // Use the load function to load the audio file
                } catch (error) {
                    console.error('Error loading audio file:', error);
                }

                // Schedule the sound to start at the next measure
                Tone.Transport.schedule(time => {
                    players[type].start(time);
                }, '@1m'); // '@1m' means the next measure
            }

            // Function to load and play audio using Tone.js
            async function loadAndPlay(audioFile) {
                const player = new Tone.Player().toDestination();
                try {
                    await player.load(audioFile); // Use the load function to load the audio file
                } catch (error) {
                    console.error('Error loading audio file:', error);
                }
                return player;
            }

            // Function to start recording
            function startRecording() {
                // Start the recorder
                recorder.start();
                console.log('Recording started');
            }

            // Function to stop recording and export the audio
            function stopRecordingAndExport() {
                // Stop the recorder and export the audio
                recorder.stop();
                recorder.export().then(function (blob) {
                    // Create a link element
                    let url = URL.createObjectURL(blob);
                    let a = document.createElement("a");

                    // Set the link attributes
                    a.href = url;
                    a.download = 'output.wav';

                    // Append the link to the body and click it to start the download
                    document.body.appendChild(a);
                    a.click();

                    console.log('Recording exported');
                });
            }


            // Function to play all selected sounds
            async function playAll() {
                const drums = document.getElementById('drums-selection').value;
                const bass = document.getElementById('bass-selection').value;
                const chords = document.getElementById('chords-selection').value;
                const melodies = document.getElementById('melodies-selection').value;

                if (drums) selectSound({getAttribute: () => drums}, 'drums');
                if (bass) selectSound({getAttribute: () => bass}, 'bass');
                if (chords) selectSound({getAttribute: () => chords}, 'chords');
                if (melodies) selectSound({getAttribute: () => melodies}, 'melodies');

                // Start the transport to begin the scheduled events
                Tone.Transport.start();
            }

            // Function to stop all sounds
            function stopAll() {
                for (let type in players) {
                    if (players[type]) {
                        players[type].stop();
                    }
                }
            }



    </script>
</head>
<body>
<!-- Main container for the webpage -->
<div class="container">
    <!-- Title of the webpage -->
    <h1 class="text-center mt-5">Music Box</h1>
    <!-- Row for the instrument sections -->
    <div class="row mt-5">
        <!-- Column for each instrument type -->
        <div class="col">
            <!-- Title for the instrument type -->
            <h2 class="text-center">Drums</h2>
            <!-- Row for the instrument buttons -->
            <div class="row">
                <!-- Cell for each instrument button, with Thymeleaf each loop to generate buttons for each instrument -->
                <div class="cell col-12 text-center" th:each="drumEntry : ${drums}" th:data-audio="@{${drumEntry.value.audioFile}}" th:data-type="drums" onclick="resumeToneContext(); selectSound(this, 'drums')">
                    <!-- Button to play the instrument sound -->
                    <button class="btn btn-primary"><i class="fas fa-play"></i></button>
                </div>
            </div>
        </div>
        <div class="col">
            <h2 class="text-center">Bass</h2>
            <div class="row">
                <div class="cell col-12 text-center" th:each="bassEntry : ${bass}" th:data-audio="@{${bassEntry.value.audioFile}}" th:data-type="bass" onclick="resumeToneContext(); selectSound(this, 'bass')">
                    <button class="btn btn-primary"><i class="fas fa-play"></i></button>
                </div>
            </div>
        </div>
        <div class="col">
            <h2 class="text-center">Chords</h2>
            <div class="row">
                <div class="cell col-12 text-center" th:each="chordEntry : ${chords}" th:data-audio="@{${chordEntry.value.audioFile}}" th:data-type="chords" onclick="resumeToneContext(); selectSound(this, 'chords')">
                    <button class="btn btn-primary"><i class="fas fa-play"></i></button>
                </div>
            </div>
        </div>
        <div class="col">
            <h2 class="text-center">Melodies</h2>
            <div class="row">
                <div class="cell col-12 text-center" th:each="melodyEntry : ${melodies}" th:data-audio="@{${melodyEntry.value.audioFile}}" th:data-type="melodies" onclick="resumeToneContext(); selectSound(this, 'melodies')">
                    <button class="btn btn-primary"><i class="fas fa-play"></i></button>
                </div>
            </div>
        </div>
    </div>
    <!-- Hidden inputs to store the selected sounds for each instrument type -->
    <input type="hidden" id="drums-selection" value="">
    <input type="hidden" id="bass-selection" value="">
    <input type="hidden" id="chords-selection" value="">
    <input type="hidden" id="melodies-selection" value="">
    <!-- Button to start the Tone.js audio context -->
    <button id="start-button" class="btn btn-primary mt-3">Start</button>
    <!-- Button to play all selected sounds -->
    <button class="btn btn-success mt-3" onclick="resumeToneContext(); playAll()">Play All</button>
    <!-- Button to stop all sounds -->
    <button class="btn btn-danger mt-3" onclick="stopAll()">Stop All</button>
    <!-- Button to start recording -->
    <button id="record-button" class="btn btn-warning mt-3" onclick="startRecording()">Start Recording</button>
    <!-- Button to stop recording and export the audio -->
    <button id="export-button" class="btn btn-info mt-3" onclick="stopRecordingAndExport()">Export Recording</button>
</div>

<!-- Link to Tone.js library -->
<script src="https://cdn.jsdelivr.net/npm/tone@15.0.4/build/Tone.js"></script>
<!-- Custom JavaScript code for the webpage -->
<script type="module">
    // Initialize the recorder
    recorder = new Tone.Recorder().toDestination();

    // Attach event listeners
    document.querySelectorAll('.cell').forEach(cell => {
        cell.addEventListener('click', function() {
            resumeToneContext();
            selectSound(this, this.getAttribute('data-type'));
        });
    });

    document.getElementById('start-button').addEventListener('click', function () {
        resumeToneContext();
        playSound();
    });
    document.querySelector('.btn-success').addEventListener('click', function() {
        resumeToneContext();
        playAll();
    });

    // Add event listener for 'Stop All' button
    document.querySelector('.btn-danger').addEventListener('click', stopAll);
</script>

</body>
</html>